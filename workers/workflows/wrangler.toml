# DE Workflows Worker Configuration
# Cloudflare Workflows for long-running operations

name = "de-workflows"
main = "index.ts"
compatibility_date = "2024-11-20"
compatibility_flags = ["nodejs_compat"]

# Worker settings
workers_dev = true

# VideoRenderWorkflow - handles Shotstack video rendering
[[workflows]]
name = "video-render-workflow"
binding = "VIDEO_RENDER_WORKFLOW"
class_name = "VideoRenderWorkflow"

# CodeExecutionWorkflow - handles code execution with fallover
[[workflows]]
name = "code-execution-workflow"
binding = "CODE_EXECUTION_WORKFLOW"
class_name = "CodeExecutionWorkflow"

# TextGenerationWorkflow - waterfall routing for text generation
# Uses: runners (if idle) → Nemotron → z.ai → Anthropic → Gemini → OpenAI
[[workflows]]
name = "text-generation-workflow"
binding = "TEXT_GENERATION_WORKFLOW"
class_name = "TextGenerationWorkflow"

# PrimeWorkflow - unified entry point for all requests
# Classifies tasks and routes to appropriate sub-workflows
[[workflows]]
name = "prime-workflow"
binding = "PRIME_WORKFLOW"
class_name = "PrimeWorkflow"

# ImageGenerationWorkflow - handles image generation
# Uses: Ideogram → DALL-E → Stability fallback
[[workflows]]
name = "image-generation-workflow"
binding = "IMAGE_GENERATION_WORKFLOW"
class_name = "ImageGenerationWorkflow"

# AudioGenerationWorkflow - handles speech synthesis
# Uses: ElevenLabs → OpenAI TTS fallback
[[workflows]]
name = "audio-generation-workflow"
binding = "AUDIO_GENERATION_WORKFLOW"
class_name = "AudioGenerationWorkflow"

# D1 Database binding (shared DE database)
[[d1_databases]]
binding = "DB"
database_name = "de-database"
database_id = "7cff30a0-c974-4ede-b96a-c91dd2f0c870"

# R2 bucket for video storage (optional - videos stored at Shotstack URL)
# [[r2_buckets]]
# binding = "R2_BUCKET"
# bucket_name = "de-render-storage"

# Environment Variables
[vars]
DELIVERY_URL = "https://delivery.distributedelectrons.com"
SHOTSTACK_ENV = "stage"
CONFIG_SERVICE_URL = "https://api.distributedelectrons.com"
# Sandbox executor for code execution (handles runner routing + fallback)
SANDBOX_EXECUTOR_URL = "https://sandbox-executor.solamp.workers.dev"
# Direct runner URLs (kept for backwards compatibility, sandbox-executor is preferred)
CLAUDE_RUNNER_URL = "https://claude-runner.shiftaltcreate.com"
GEMINI_RUNNER_URL = "https://gemini-runner.shiftaltcreate.com"
NEXUS_API_URL = "https://nexus-mcp.solamp.workers.dev"
# Spark vLLM endpoint for Nemotron (local inference)
SPARK_VLLM_URL = "https://vllm.shiftaltcreate.com"
# Queue depth threshold - skip runners if more tasks are queued (default: 3)
QUEUE_DEPTH_THRESHOLD = "3"
# Image generation worker URL
IMAGE_GEN_URL = "https://image-gen.solamp.workers.dev"
# Audio generation worker URL
AUDIO_GEN_URL = "https://audio-gen.solamp.workers.dev"
# Default model waterfall for code execution (comma-separated model names)
# Order: Claude Sonnet (balanced) → Gemini Flash (fast) → Claude Opus (powerful) → GLM-4 (local)
DEFAULT_MODEL_WATERFALL = "claude-sonnet-4.5,gemini-2.0-flash-exp,claude-opus-4.5,glm-4-7b"

# Secrets (set via wrangler secret put):
# - SHOTSTACK_API_KEY
# - RUNNER_SECRET (for claude-runner auth)
# - GEMINI_RUNNER_SECRET (for gemini-runner auth)
# - CF_ACCESS_CLIENT_ID (optional - for Cloudflare Access protected runners)
# - CF_ACCESS_CLIENT_SECRET (optional - for Cloudflare Access protected runners)
# - NEXUS_PASSPHRASE (for Nexus MCP server write access)
# - NTFY_TOPIC (optional - for quarantine notifications)
# - CF_AIG_TOKEN (Cloudflare AI Gateway token - routes API calls through Gateway)
# - ZAI_API_KEY (for z.ai API - direct, not through Gateway)
# - ANTHROPIC_API_KEY (fallback if CF_AIG_TOKEN not set)
# - GEMINI_API_KEY (fallback if CF_AIG_TOKEN not set)
# - OPENAI_API_KEY (fallback if CF_AIG_TOKEN not set)

# Custom Domain (optional)
# [[routes]]
# pattern = "workflows.distributedelectrons.com"
# custom_domain = true
